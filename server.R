# OYD: Beziehungsmonitor  - last update:2016-05-20
# Manifest for relationship app ===================================
'
encode with https://www.base64encode.org/
{
        "name":"Relationship App",
        "identifier":"eu.ownyourdata.relationship",
        "type":"external",
        "description":"monitor your relationship status",
        "permissions":["eu.ownyourdata.relationship.energy:read",
                       "eu.ownyourdata.relationship.energy:write",
                       "eu.ownyourdata.relationship.energy:update",
                       "eu.ownyourdata.relationship.energy:delete",
                       "eu.ownyourdata.relationship.satisfaction:read",
                       "eu.ownyourdata.relationship.satisfaction:write",
                       "eu.ownyourdata.relationship.satisfaction:update",
                       "eu.ownyourdata.relationship.satisfaction:delete",
                       "eu.ownyourdata.relationship.health:read",
                       "eu.ownyourdata.relationship.health:write",
                       "eu.ownyourdata.relationship.health:update",
                       "eu.ownyourdata.relationship.health:delete",
                       "eu.ownyourdata.relationship.relaxation:read",
                       "eu.ownyourdata.relationship.relaxation:write",
                       "eu.ownyourdata.relationship.relaxation:update",
                       "eu.ownyourdata.relationship.relaxation:delete",
                       "eu.ownyourdata.relationship.general:read",
                       "eu.ownyourdata.relationship.general:write",
                       "eu.ownyourdata.relationship.general:update",
                       "eu.ownyourdata.relationship.general:delete",
                       "eu.ownyourdata.scheduler:read",
                       "eu.ownyourdata.scheduler:write",
                       "eu.ownyourdata.scheduler:update",
                       "eu.ownyourdata.scheduler:delete",
                       "eu.ownyourdata.scheduler.email_config:read",
                       "eu.ownyourdata.scheduler.email_config:write",
                       "eu.ownyourdata.scheduler.email_config:update",
                       "eu.ownyourdata.scheduler.email_config:delete"]
}
ew0KICAgICAgICAibmFtZSI6IlJlbGF0aW9uc2hpcCBBcHAiLA0KICAgICAgICAiaWRlbnRpZmllciI6ImV1Lm93bnlvdXJkYXRhLnJlbGF0aW9uc2hpcCIsDQogICAgICAgICJ0eXBlIjoiZXh0ZXJuYWwiLA0KICAgICAgICAiZGVzY3JpcHRpb24iOiJ0cmFjayB5b3VyIHJlbGF0aW9uc2hpcCBzdGF0dXMiLA0KICAgICAgICAicGVybWlzc2lvbnMiOlsiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLmVuZXJneTpyZWFkIiwNCiAgICAgICAgICAgICAgICAgICAgICAgImV1Lm93bnlvdXJkYXRhLnJlbGF0aW9uc2hpcC5lbmVyZ3k6d3JpdGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLmVuZXJneTp1cGRhdGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLmVuZXJneTpkZWxldGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLnNhdGlzZmFjdGlvbjpyZWFkIiwNCiAgICAgICAgICAgICAgICAgICAgICAgImV1Lm93bnlvdXJkYXRhLnJlbGF0aW9uc2hpcC5zYXRpc2ZhY3Rpb246d3JpdGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLnNhdGlzZmFjdGlvbjp1cGRhdGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLnNhdGlzZmFjdGlvbjpkZWxldGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLmhlYWx0aDpyZWFkIiwNCiAgICAgICAgICAgICAgICAgICAgICAgImV1Lm93bnlvdXJkYXRhLnJlbGF0aW9uc2hpcC5oZWFsdGg6d3JpdGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLmhlYWx0aDp1cGRhdGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLmhlYWx0aDpkZWxldGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLnJlbGF4YXRpb246cmVhZCIsDQogICAgICAgICAgICAgICAgICAgICAgICJldS5vd255b3VyZGF0YS5yZWxhdGlvbnNoaXAucmVsYXhhdGlvbjp3cml0ZSIsDQogICAgICAgICAgICAgICAgICAgICAgICJldS5vd255b3VyZGF0YS5yZWxhdGlvbnNoaXAucmVsYXhhdGlvbjp1cGRhdGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLnJlbGF4YXRpb246ZGVsZXRlIiwNCiAgICAgICAgICAgICAgICAgICAgICAgImV1Lm93bnlvdXJkYXRhLnJlbGF0aW9uc2hpcC5nZW5lcmFsOnJlYWQiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLmdlbmVyYWw6d3JpdGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEucmVsYXRpb25zaGlwLmdlbmVyYWw6dXBkYXRlIiwNCiAgICAgICAgICAgICAgICAgICAgICAgImV1Lm93bnlvdXJkYXRhLnJlbGF0aW9uc2hpcC5nZW5lcmFsOmRlbGV0ZSIsDQogICAgICAgICAgICAgICAgICAgICAgICJldS5vd255b3VyZGF0YS5zY2hlZHVsZXI6cmVhZCIsDQogICAgICAgICAgICAgICAgICAgICAgICJldS5vd255b3VyZGF0YS5zY2hlZHVsZXI6d3JpdGUiLA0KICAgICAgICAgICAgICAgICAgICAgICAiZXUub3dueW91cmRhdGEuc2NoZWR1bGVyOnVwZGF0ZSIsDQogICAgICAgICAgICAgICAgICAgICAgICJldS5vd255b3VyZGF0YS5zY2hlZHVsZXI6ZGVsZXRlIiwNCiAgICAgICAgICAgICAgICAgICAgICAgImV1Lm93bnlvdXJkYXRhLnNjaGVkdWxlci5lbWFpbF9jb25maWc6cmVhZCIsDQogICAgICAgICAgICAgICAgICAgICAgICJldS5vd255b3VyZGF0YS5zY2hlZHVsZXIuZW1haWxfY29uZmlnOndyaXRlIiwNCiAgICAgICAgICAgICAgICAgICAgICAgImV1Lm93bnlvdXJkYXRhLnNjaGVkdWxlci5lbWFpbF9jb25maWc6dXBkYXRlIiwNCiAgICAgICAgICAgICAgICAgICAgICAgImV1Lm93bnlvdXJkYXRhLnNjaGVkdWxlci5lbWFpbF9jb25maWc6ZGVsZXRlIl0NCn0=
'

# Setup and config ========================================
# install.packages(c('shiny', 'shinyBS', 'DT', 'tidyr', 'digest', 'RCurl', 'jsonlite', 'dplyr'), repos='https://cran.rstudio.com/')
library(shiny)
library(digest)
library(tidyr)
library(RCurl)
library(jsonlite)
library(dplyr)

source("oyd_helpers.R")

first <- TRUE
repo_relshp <- 'eu.ownyourdata.relationship'
repo_health <- paste0(repo_relshp, '.health')
repo_energy <- paste0(repo_relshp, '.energy')
repo_satisfaction <- paste0(repo_relshp, '.satisfaction')
repo_relaxation <- paste0(repo_relshp, '.relaxation')
repo_general <- paste0(repo_relshp, '.general')

# Shiny Server ============================================
shinyServer(function(input, output, session){
        output$upgradeLink <- renderText({
                renderUpgrade(session)
        })
        
# relationship specific functions =================================
        relshpRepo <- reactive({
                url <- input$relshp_url
                app_key <- input$relshp_app_key
                app_secret <- input$relshp_app_secret
                if((nchar(url) > 0) & 
                   (nchar(app_key) > 0) & 
                   (nchar(app_secret) > 0)) {
                        if(input$localRelshpSave) {
                                save(url, 
                                     app_key, 
                                     app_secret, 
                                     file='~/relshpCredentials.RData')
                        } else {
                                # if (file.exists('~/relshpCredentials.RData'))
                                #         file.remove('~/relshpCredentials.RData')
                        }
                        getRepo(url, app_key, app_secret)
                } else {
                        vector()
                }
        })

        combineData <- function(dat1, dat2){
                data <- data.frame()
                if(nrow(dat1) == 0) {
                        data <- dat2
                } else {
                        if(nrow(dat2) == 0){
                                data <- dat1
                        } else {
                                data <- merge(dat1[, !names(dat1) %in% c('id')], 
                                              dat2[, !names(dat2) %in% c('id')],
                                              by='date', all=TRUE)
                        }
                }
                data
        }
        
        relshpData <- function(category){
                repo <- relshpRepo()
                if(length(repo) > 0) {
                        url <- itemsUrl(repo[['url']], 
                                        paste0(repo[['app_key']], 
                                               '.', category))
                        piaData <- readItems(repo, url)
                        if(nrow(piaData)>0){
                                names(piaData)[names(piaData) == 'value'] <-
                                        paste0(category, '1')
                                names(piaData)[names(piaData) == 'value2'] <-
                                        paste0(category, '2')
                        }
                } else {
                        piaData <- data.frame()
                }
                piaData
        }
        
        allRelshpData <- function(){
                # load individual data sets
                g_data <- relshpData('general')
                e_data <- relshpData('energy')
                s_data <- relshpData('satisfaction')
                h_data <- relshpData('health')
                r_data <- relshpData('relaxation')
                
                # merge data sets
                data <- combineData(g_data, e_data)
                data <- combineData(s_data, data)
                data <- combineData(h_data, data)
                data <- combineData(r_data, data)
                
                # create return Value
                if(nrow(data) > 0) {
                        data$dat <- as.POSIXct(data$date, 
                                               format='%Y-%m-%d')
                        data[with(data, order(dat)),]
                } else {
                        data.frame()
                }
        }
        
        plotCategory <- function(data, category){
                dataMin <- min(data$dat, na.rm=TRUE)
                dataMax <- max(data$dat, na.rm=TRUE)
                curMin <- as.Date(input$dateRange[1], '%d.%m.%Y')
                curMax <- as.Date(input$dateRange[2], '%d.%m.%Y')
                daterange <- seq(curMin, curMax, 'days')
                data <- data[as.Date(data$dat) %in% daterange, ]
                if(nrow(data) > 0) {
                        title <- ''
                        title <- switch(category, 
                                        general={ 'Allgemein' },
                                        energy={ 'Energie' },
                                        health={ 'Gesundheit' },
                                        satisfaction={ 'Zufriedenheit' },
                                        relaxation={ 'Entspannung' },
                                        { '' }
                        )
                        closeAlert(session, 'noDataAlert')
                        data1 <- data[,c('dat', paste0(category, '1'))]
                        data1 <- data1[complete.cases(data1),]
                        data2 <- data[,c('dat', paste0(category, '2'))]
                        data2 <- data2[complete.cases(data2),]
                        plotMin <- min(min(data1$dat, na.rm=TRUE), 
                                       min(data2$dat, na.rm=TRUE))
                        plotMax <- max(max(data1$dat, na.rm=TRUE),
                                       max(data2$dat, na.rm=TRUE))
                        curDaterange <- as.Date(seq(plotMin, plotMax, 'days'))
                        # curve1 <- smooth.spline(data1$dat, 
                        #                         data1[[paste0(category, '1')]], 
                        #                         df=20)
                        # curve2 <- smooth.spline(data2$dat, 
                        #                         data2[[paste0(category, '2')]], 
                        #                         df=20)
                        curve1 <- data.frame(data1$dat, 
                                             data1[paste0(category, '1')])
                        colnames(curve1) <- c('x', 'y')
                        curve2 <- data.frame(data2$dat, 
                                             data2[paste0(category, '2')])
                        colnames(curve2) <- c('x', 'y')
                        plot(curve1, col='green', lwd=5, main=title,
                             type='l', xlab='Datum', ylab='Wert', 
                             ylim=c(1,11), xaxt='n')
                        axis.POSIXct(side=1, curDaterange, format = "%b %y")
                        
                        d <- as.integer(as.POSIXct(data[
                                which(abs(data[paste0(category, '1')] -
                                          data[paste0(category, '2')]) > 3),
                                'date']))
                        delta <- 1200000
                        for(i in 1:length(d)){
                                polygon(x=c(curve1$x[which(curve1$x>=(d[i]-delta) & curve1$x<=(d[i]+delta))], 
                                            rev(curve2$x[which(curve2$x>=(d[i]-delta) & curve2$x<=(d[i]+delta))])), 
                                        y=c(curve1$y[which(curve1$x>=(d[i]-delta) & curve1$x<=(d[i]+delta))], 
                                            rev(curve2$y[which(curve2$x>=(d[i]-delta) & curve2$x<=(d[i]+delta))])), 
                                        col="mistyrose", border=NA)
                        }
                        lines(curve1, col='green', lwd=5)
                        lines(curve2, col='orange', lwd=5)
                } else {
                        createAlert(session, 'noData', 'noDataAlert', style='warning', 
                                    title='Keine Daten im ausgewählten Zeitfenster',
                                    content=paste0('Passen sie links die Zeitauswahl an - es stehen Daten zwischen ',
                                                   format(as.POSIXct(dataMin, '%Y-%m-%d'), '%d.%m.%Y'),
                                                   ' und ',
                                                   format(as.POSIXct(dataMax, '%Y-%m-%d'), '%d.%m.%Y'),
                                                   ' zur Verfügung.'))
                }
        }

        plotData <- function(category){
                if(first) {
                        internetAlert(session, 'https://www.ownyourdata.eu/apps/')
                        first <<- FALSE                  
                }
                closeAlert(session, 'noDataAlert')
                data <- allRelshpData()
                if(nrow(data) > 0) {
                        plotCategory(data, category)
                } else {
                        createAlert(session, 'noData', 'noDataAlert', style='info', title='Keine Daten vorhanden',
                                    content='Erfassen sie links Daten oder abonnieren sie periodische Emails, um die Ergebnisse des Beziehungsstatus anzuzeigen.', append=FALSE)
                }
        }
        
        writeRelshp <- function(category){
                repo <- relshpRepo()
                date <- input$manDate
                Category <- paste0(toupper(substring(category, 1, 1)),
                                   substring(category, 2))
                url <- itemsUrl(repo[['url']], 
                                paste0(repo[['app_key']], '.', category))
                if(input[[paste0('use', Category, '1')]]){
                        valueField <- paste0('man', Category, '1')
                        value1 <- input[[valueField]]
                } else {
                        value1 <- NA
                }
                if(input[[paste0('use', Category, '2')]]){
                        valueField <- paste0('man', Category, '2')
                        value2 <- input[[valueField]]
                } else {
                        value2 <- NA
                }
                if((input[[paste0('use', Category, '1')]]) |
                   (input[[paste0('use', Category, '2')]])){
                        piaData <- relshpData(category)
                        existData <- piaData[piaData$date == date, ]
                        data <- list(date=date,
                                     value=value1,
                                     value2=value2)
                        if (nrow(existData) > 0) {
                                updateRecord(repo, url, data, existData$id)
                        } else {
                                writeRecord(repo, url, data)
                        }
                }        
        }
        
        writeAllRelshp <- function(){
                writeRelshp('general')
                writeRelshp('energy')
                writeRelshp('satisfaction')
                writeRelshp('health')
                writeRelshp('relaxation')
        }
        
        savedPia <- eventReactive(input$exportButton, {
                repo <- relshpRepo()
                writeAllRelshp()
                output$plotGeneral <- renderPlot(plotData('general'))
                output$plotEnergy <- renderPlot(plotData('energy'))
                output$plotHealth <- renderPlot(plotData('health'))
                output$plotSatisfaction <- renderPlot(plotData('satisfaction'))
                output$plotRelaxation <- renderPlot(plotData('relaxation'))
                paste('<strong>zuletzt aktualisiert:</strong>',
                      format(Sys.time(), '%H:%M:%S'))
        })

# Bank specific output fields =============================
        output$plotGeneral <- renderPlot({
                plotData('general')
        })
        
        output$plotEnergy <- renderPlot({
                plotData('energy')
        })
        
        output$plotHealth <- renderPlot({
                plotData('health')
        })
        
        output$plotSatisfaction <- renderPlot({
                plotData('satisfaction')
        })
        
        output$plotRelaxation <- renderPlot({
                plotData('relaxation')
        })

        output$table <- DT::renderDataTable({
                data <- bankData()
                closeAlert(session, 'noDataAlert')
                data <- bankData()
                if(nrow(data) > 0) {
                        dataMin <- min(data$dat)
                        dataMax <- max(data$dat)
                        curMin <- as.Date(input$dateRange[1], '%d.%m.%Y')
                        curMax <- as.Date(input$dateRange[2], '%d.%m.%Y')
                        daterange <- seq(curMin, curMax, 'days')
                        data$cumsum <- cumsum(data$value)
                        data <- data[as.Date(data$dat) %in% daterange, ]
                        if(nrow(data) > 0) {
                                myData <- data[, c('date', 'value', 'description')]
                                colnames(myData) <- c('Datum', 'Betrag', 'Beschreibung')
                                DT::datatable(myData, options = list(pageLength = 25))
                        } else {
                                createAlert(session, 'noData', 'noDataAlert', style='warning', title='Keine Daten im ausgewählten Zeitfenster',
                                            content=paste0('Passen sie links die Zeitauswahl an - es stehen Daten zwischen ',
                                                           format(as.POSIXct(dataMin, '%Y-%m-%d'), '%d.%m.%Y'),
                                                           ' und ',
                                                           format(as.POSIXct(dataMax, '%Y-%m-%d'), '%d.%m.%Y'),
                                                           ' zur Verfügung.'))
                        }
                } else {
                        createAlert(session, 'noData', 'noDataAlert', style='info', title='Keine Daten vorhanden',
                                    content='Laden sie ihren Kontoauszug hoch und/oder verbinden sie sich zu ihrer PIA, um die Kontoentwicklung anzuzeigen.', append=FALSE)
                }
        })
        
        output$last_saved <- renderText({
                savedPia()
        })
        
        output$relshp_token <- renderText({
                repo <- relshpRepo()
                if (length(repo) == 0) {
                        '<strong>Token:</strong> nicht verfügbar'
                } else {
                        paste0('<strong>Token:</strong><br><small>', 
                               repo[['token']], '</small>')
                }
        })
        
        output$relshp_records <- renderText({
                data <- allRelshpData()
                paste('<strong>Datensätze:</strong>',
                      nrow(data))
        })

# Email reminders =========================================        
        getLocalEmailConfig <- reactive({
                validEmailConfig <- FALSE
                server <- input$mailer_address
                port <- input$mailer_port
                user <- input$mailer_user
                pwd <- input$mailer_password
                if((nchar(server) > 0) & 
                   (nchar(port) > 0) & 
                   (nchar(user) > 0) & 
                   (nchar(pwd) > 0)) {
                        validEmailConfig <- TRUE
                }
                c('valid'=validEmailConfig,
                  'server'=server,
                  'port'=port,
                  'user'=user,
                  'pwd'=pwd)
        })

        emailConfigStatus <- function(repo){
                localMailConfig <- getLocalEmailConfig()
                piaMailConfig <- getPiaEmailConfig(repo)
                if (localMailConfig[['valid']]) {
                        # is there already a config in PIA?
                        if (length(piaMailConfig) > 0) {
                                # is it different?
                                if((localMailConfig[['server']] == piaMailConfig[['server']]) &
                                   (localMailConfig[['port']] == piaMailConfig[['port']]) &
                                   (localMailConfig[['user']] == piaMailConfig[['user']]) &
                                   (localMailConfig[['pwd']] == piaMailConfig[['pwd']])) {
                                        'config in sync'
                                } else {
                                        updateEmailConfig(repo, 
                                                          localMailConfig, 
                                                          piaMailConfig[['id']])
                                        'config updated'
                                }
                        } else {
                                writeEmailConfig(repo, localMailConfig)
                                'config saved'
                        }
                } else {
                        # is there already a config in PIA?
                        if (length(piaMailConfig) > 0) {
                                setEmailConfig(session, piaMailConfig)
                                'config loaded' # Mailkonfiguration von PIA gelesen
                        } else {
                                'not configured' # keine Mailkonfiguration vorhanden
                        }
                }
        }
        
        setSchedulerEmails <- function(session, email, number){
                updateTextInput(session, paste0('email', number), 
                                value=email)
        }
        
        getPiaSchedulerEmails <- function(repo, number){
                url <- itemsUrl(repo[['url']], 
                                schedulerKey())
                retVal <- readItems(repo, url)
                if(nrow(retVal) == 0) {
                        vector()
                } else {
                        retVal <- retVal[retVal$repo == repo[['app_key']] & 
                                         retVal$task == 'email', ]
                        useVal <- data.frame()
                        if(nrow(retVal) > 0) {
                                for(i in 1:nrow(retVal)){
                                        if(number == 1){
                                                if(colnames(retVal$parameters$response_structure[[i]]$fields)[2] == 'value') {
                                                        useVal <- retVal[i,]
                                                }
                                        } else {
                                                if(colnames(retVal$parameters$response_structure[[i]]$fields)[2] == 'value2') {
                                                        useVal <- retVal[i,]
                                                }
                                        }
                                }
                                if(nrow(useVal) > 0) {
                                        c(id=useVal$id,
                                          email=useVal$parameters$address)
                                } else {
                                        vector()
                                }
                        } else {
                                vector()
                        }
                }
        }

        emailReminderStatus <- function(number){
                repo <- relshpRepo()
                piaMailConfig <- getPiaEmailConfig(repo)
                piaSchedulerEmail <- getPiaSchedulerEmails(repo, number)
                piaEmail <- ''
                piaEmailId <- NA
                if (length(piaSchedulerEmail) > 0) {
                        piaEmail <- piaSchedulerEmail[['email']]
                        piaEmailId <-  piaSchedulerEmail[['id']]
                }
                localEmail <- as.character(input[[paste0('email', number)]])
                if(validEmail(localEmail)) {
                        if (localEmail == piaEmail) {
                                'email in sync'
                        } else {
                                if(number == 1){
                                        energy_fields <- list(
                                                date='Date.now',
                                                value='line_1(integer)')
                                        health_fields <- list(
                                                date='Date.now',
                                                value='line_2(integer)')
                                        satisfaction_fields <- list(
                                                date='Date.now',
                                                value='line_3(integer)')
                                        relaxation_fields <- list(
                                                date='Date.now',
                                                value='line_4(integer)')
                                        general_fields <- list(
                                                date='Date.now',
                                                value='line_5(integer)')
                                } else {
                                        energy_fields <- list(
                                                date='Date.now',
                                                value2='line_1(integer)')
                                        health_fields <- list(
                                                date='Date.now',
                                                value2='line_2(integer)')
                                        satisfaction_fields <- list(
                                                date='Date.now',
                                                value2='line_3(integer)')
                                        relaxation_fields <- list(
                                                date='Date.now',
                                                value2='line_4(integer)')
                                        general_fields <- list(
                                                date='Date.now',
                                                value2='line_5(integer)')
                                }
                                energy_structure <- list(
                                        repo=repo_energy,
                                        fields=energy_fields)
                                health_structure <- list(
                                        repo=repo_health,
                                        fields=health_fields)
                                satisfaction_structure <- list(
                                        repo=repo_satisfaction,
                                        fields=satisfaction_fields)
                                relaxation_structure <- list(
                                        repo=repo_relaxation,
                                        fields=relaxation_fields)
                                general_structure <- list(
                                        repo=repo_general,
                                        fields=general_fields)
                                response_structure <- list(
                                        health_structure,
                                        energy_structure,
                                        satisfaction_structure,
                                        relaxation_structure,
                                        general_structure)
                                content <- 'Bewerte die folgenden 5 Aspekte der letzten Woche auf einer Skala von 1 (gering) bis 10 (hoch) in der angegebenen Reihenfolge und verwende jeweils 1 Zeile: Energie, Gesundheit, Zufriedenheit, Entspannung und Allgemein.'
                                timePattern <- '0 9 * * 0'
                                if (piaEmail == '') {
                                        writeSchedulerEmail(
                                                repo,
                                                localEmail,
                                                content,
                                                timePattern,
                                                response_structure)
                                        'email saved'
                                } else {
                                        updateSchedulerEmail(
                                                repo,
                                                localEmail,
                                                content,
                                                timePattern,
                                                response_structure,
                                                piaEmailId)
                                        'email updated'
                                }
                        } 
                } else {
                        if (nchar(localEmail) == 0) {
                                if (piaEmail == '') {
                                        'missing email'
                                } else {
                                        setSchedulerEmails(session, piaEmail, number)
                                        'email loaded'
                                }
                        } else {
                                'invalid email'
                        }
                }
        }

        output$mail_config <- renderText({
                repo <- relshpRepo()
                retVal <- emailConfigStatus(repo)
                switch(retVal,
                       'config in sync' = 'Benachrichtigungen via Email sind eingerichtet',
                       'not configured' = 'Benachrichtigungen via Email sind noch nicht konfiguiert',
                       'config saved'   = 'Emailkonfiguration in PIA gespeichert',
                       'config updated' = 'Emailkonfiguration in PIA aktualisiert',
                       'config loaded'  = 'Emailkonfiguration aus PIA geladen')
        })
        
        output$email_status <- renderText({
                repo <- relshpRepo()
                piaMailConfig <- getPiaEmailConfig(repo)
                if (length(piaMailConfig) == 0) {
                        '<strong>Status:</strong> Email-Konfiguration noch nicht vorhanden'
                } else {
                        retVal1 <- emailReminderStatus(1)
                        status1 <- switch(retVal1,
                                          'missing email'  = 'fehlende Emailadresse für Person #1',
                                          'invalid email'  = 'ungültige Emailadresse für Person #1',
                                          'email loaded'   = 'Emailadresse für Person #1 aus PIA geladen',
                                          'email in sync'  = 'periodische Email-Benachrichtigungen für Person #1 werden versandt',
                                          'email saved'    = 'Emailadresse für Person #1 in PIA gespeichert',
                                          'email updated'  = 'Emailadresse für Person #1 in PIA aktualisiert')
                        retVal2 <- emailReminderStatus(2)
                        status2 <- switch(retVal2,
                                          'missing email'  = 'fehlende Emailadresse für Person #2',
                                          'invalid email'  = 'ungültige Emailadresse für Person #2',
                                          'email loaded'   = 'Emailadresse für Person #2 aus PIA geladen',
                                          'email in sync'  = 'periodische Email-Benachrichtigungen für Person #2 werden versandt',
                                          'email saved'    = 'Emailadresse für Person #2 in PIA gespeichert',
                                          'email updated'  = 'Emailadresse für Person #2 in PIA aktualisiert')
                        paste0(status1, ', ', status2)
                }
        })

})
